name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        # 这很重要：获取所有分支和标签信息
        fetch-depth: 0
        # 明确指定要检出的ref
        ref: ${{ github.ref }}
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Gradle
      run: ./gradlew build
    
    - name: Get branch name
      id: get_branch
      run: |
        # 安全地获取分支名，避免与标签冲突
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push changes
      run: |
        # 添加更改
        git add .
        
        # 提交更改
        git commit -m "Apply spotless formatting [skip ci]" || exit 0
        
        # 安全推送：明确推送当前分支
        git push origin HEAD:${{ github.ref }}
